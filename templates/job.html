<% extends "base.html" %>

<% block content %>
<section class="section" id="job">
    <div class="container">
        <h1 class="title">Job '{{job.name}}'</h1>

        <div style="margin-bottom: 15px"><button class="button is-warning" v-on:click="cancelJob">Cancel job</button> </div>

        <table class="table is-bordered">
            <tr><th>State</th><td>{{job.state}}</td></tr>
            <tr><th>Target revision</th><td>{{job.target_revision}}</td></tr>
            <tr><th>YunoHost version</th><td>{{job.yunohost_version}}</td></tr>
            <tr><th>Created time</th><td>{{timestampToDate(job.created_time)}}</td></tr>
            <tr><th>Started time</th><td>{{timestampToDate(job.started_time)}}</td></tr>
            <tr><th>End time</th><td>{{timestampToDate(job.end_time)}}</td></tr>
        </table>

        <h2 class="subtitle">Excution log:</h2>
        <pre class="consoleOutput" v-html="logWithColors"></pre>
    </div>
</section>
<% endblock %>

<% block javascript %>
<style>
    .consoleOutput {
        max-height: 90vh;
        background-color: #222;
        color: #eee;
        padding-top: 1.25rem;
        padding-right: 1.5rem;
        padding-bottom: 1.25rem;
        padding-left: 1.5rem;
    }
</style>
<script>
    (function() {
        var app = new Vue({
            el: '#job',
            data: {
                job: {}
            },
            methods: {
                timestampToDate: function (timestamp) {
                    return new Date(timestamp * 1000).toLocaleString()
                },
                cancelJob: function() {
                    $.post("/api/job/" + this.job.id + "/stop")
                }
            },
            computed: {
                logWithColors: function() {
                    if (this.job.log != undefined) {
                        var ansiup = new AnsiUp;
                        return ansiup.ansi_to_html(this.job.log);
                    } else {
                        return "";
                    }
                }
            }
        })

        ws = new WebSocket('ws://' + document.domain + ':' + location.port + '/job-<{ job.id }>-ws');

        ws.onmessage = function (event) {
            var message = JSON.parse(event.data);
            var data = message.data;
            var action = message.action;

            if (action == "init_job" || action == "update_job") {
                app.job = data;
            }
        };
    })()
</script>
<% endblock %>
